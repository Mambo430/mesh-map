<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>MeshCore Wardrive</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="MeshCore Wardrive - Crowd-sourced mesh coverage tool">
  <meta name="keywords" content="MeshCore,coverage,wardrive,cascadia,pugetmesh">
  <meta name="author" content="Kyle Reed">
  <link rel="manifest" href="content/wardrive.json">
  <link rel="icon" href="content/wardrive.png">
  <link rel="stylesheet" href="content/tailwind.css">

  <!-- Leaflet -->
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY"
        crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo"
          crossorigin=""></script>

  <style>
    .leaflet-interactive.marker-shadow {
      filter: url(#marker-shadow);
    }
  </style>
</head>

<body class="bg-slate-900 text-slate-100">
  <main class="min-h-screen flex items-start justify-center p-4">
    <div class="w-full max-w-3xl space-y-4">

      <!-- Header ------------------------------------------------------------ -->
      <header class="flex items-center justify-between">
        <h1 class="flex items-center gap-2 text-xl font-semibold">
          <img class="h-8 w-8" src="content/wardrive.png" alt="Wardrive logo">
          MeshCore Wardrive
          <div id="rxLogStatus" class="ml-1 border border-zinc-300 bg-zinc-500 rounded-full w-3 h-3"></div>
        </h1>

        <div class="text-right text-sm">
          <span id="status" class="font-semibold text-red-300">Disconnected</span>
          <div id="deviceInfo" class="text-slate-400 text-xs"></div>
        </div>
      </header>

      <!-- Button row -------------------------------------------------------- -->
      <section class="mt-2">
        <div class="flex items-center gap-2">
          <button id="connectBtn"
                  class="px-3 py-1.5 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-sm font-medium disabled:opacity-40">
            Connect
          </button>

          <!-- <strong>Keep‚Äëscreen‚Äëlock button ‚Äì added in markup</strong> -->
          <button id="wakeBtn"
                  class="px-3 py-1.5 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-sm font-medium"
                  aria-label="Toggle keep‚Äëscreen‚Äëon">
            Screen Lock OFF
          </button>

          <div id="pingButtons" class="ml-auto flex items-center gap-2">
            <button id="sendPingBtn" disabled
                    class="px-3 py-1.5 rounded-lg bg-sky-600 hover:bg-sky-500 text-sm font-medium disabled:opacity-40">
              Send Ping
            </button>
            <button id="autoToggleBtn" disabled
                    class="px-3 py-1.5 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-sm font-medium disabled:opacity-40">
              Start Auto Ping
            </button>
          </div>
        </div>
      </section>

      <!-- The Map ----------------------------------------------------------- -->
      <div id="map" class="rounded-lg h-140 shadow-sm"></div>

      <!-- Bottom controls ----------------------------------------------------- -->
      <section class="bg-slate-800/80 border border-slate-700 rounded-lg p-2 space-y-2 shadow-sm">
        <!-- Send radio name consent -->
        <div class="space-y-1 text-xs align-middle text-slate-300 mb-4">
          <label class="flex gap-2">
            <input type="checkbox" id="sendRadioNameCB">
            Send my radio name with pings (for leaderboard).
          </label>
        </div>

        <!-- Ignore Repeater -->
        <div class="space-y-1">
          <div class="text-xs italic text-slate-400">
            If you're using a mobile repeater, ignore its id.
          </div>
          <div class="flex flex-wrap items-center gap-1">
            <button id="ignoredRepeaterBtn"
                    class="px-2 mr-2 rounded-md bg-zinc-600 hover:bg-zinc-500 text-sm disabled:opacity-40">
              Set
            </button>
            <label class="text-xs text-slate-300">Ignored Repeater Id</label>
            <div id="ignoredRepeaterId" class="text-xs text-slate-400">None</div>
          </div>
        </div>
      </section>

      <!-- Info -------------------------------------------------------------- -->
      <section>
        <div class="text-xs italic text-slate-400">
          Sends location to <span class="font-mono">#wardrive</span> to build the
          <a class="underline" target="_blank" href="/">coverage map</a>.
        </div>
        <div class="text-xs italic text-slate-400">
          Requires Bluetooth &amp; Location permissions.
        </div>
        <div class="text-xs italic text-slate-400">
          Must remain in foreground with screen on and unlocked.
        </div>
        <div class="text-xs italic text-slate-400">
          Requires
          <a class="underline" href="https://apps.apple.com/us/app/bluefy-web-ble-browser/id1492822055" target="_blank">Bluefy</a>
          on iOS, Edge or Chrome on Android.
        </div>
        <div class="text-xs italic text-slate-400">
          Only for Central West Florida (CWF) region. See <a class="underline" href="/howto" target="_blank">howto</a> for more info.
        </div>
      </section>

    </div>
  </main>

  <!-- Import Wardrive logic (module) ---------------------------------------- -->
  <script type="module">
    import { onLoad } from './content/wardrive.js';
    onLoad();
  </script>

  <!-- Wake‚ÄëLock helper ‚Äì plain JavaScript --------------------------------- -->
  <script>
    /* -------------------- Wake‚ÄëLock helper -------------------- */
    const wakeBtn = document.getElementById('wakeBtn');

    let wakeLock    = null;          // holds the WakeLockSentinel (if supported)
    let keepAliveId = null;          // fallback keep‚Äëalive timer

    /* Acquire the screen Wake‚ÄëLock (or fall back) */
    async function acquireWakeLock() {
      if (!('wakeLock' in navigator)) {
        console.warn('Wake‚ÄëLock API not supported ‚Äì using keep‚Äëalive fallback');
        startKeepAlive();
        return;
      }
      try {
        wakeLock = await navigator.wakeLock.request('screen');
        console.log('‚úÖ Wake‚ÄëLock acquired ‚Äì screen will stay on');
        wakeLock.addEventListener('release', () => {
          console.warn('‚ö†Ô∏è Wake‚ÄëLock released automatically');
          // If the page is visible, re‚Äëacquire
          if (document.visibilityState === 'visible') acquireWakeLock();
        });
      } catch (err) {
        console.error('üö® Wake‚ÄëLock request failed:', err);
      }
    }

    /* Release the Wake‚ÄëLock (if any) */
    function releaseWakeLock() {
      if (wakeLock) {
        wakeLock.release();
        wakeLock = null;
        console.log('‚ùå Wake‚ÄëLock released ‚Äì screen may sleep now');
      }
    }

    /* Keep‚Äëalive fallback ‚Äì tiny interval that keeps the page active */
    function startKeepAlive() {
      if (keepAliveId) return;
      keepAliveId = setInterval(() => { void document.title; }, 15_000); // 15‚ÄØs
      console.log('‚è±Ô∏è Keep‚Äëalive interval started (fallback)');
    }
    function stopKeepAlive() {
      if (keepAliveId) clearInterval(keepAliveId);
      keepAliveId = null;
      console.log('‚è±Ô∏è Keep‚Äëalive interval stopped');
    }

    /* Toggle button handler ------------------------------------ */
    let isLocked = false;
    function toggleScreenLock() {
      isLocked = !isLocked;
      wakeBtn.textContent = isLocked ? 'Screen Lock ON' : 'Screen Lock OFF';

      if (isLocked) {
        acquireWakeLock();   // will use fallback if not supported
        startKeepAlive();    // safety on older browsers
      } else {
        releaseWakeLock();
        stopKeepAlive();
      }
    }

    /* Wire the button click */
    wakeBtn.addEventListener('click', toggleScreenLock);
  </script>

  <!-- iOS Safari SVG shadow hack -->
  <svg width="0" height="0" style="position:absolute">
    <defs>
      <filter id="marker-shadow" x="-50%" y="-50%" width="200%" height="200%">
        <feDropShadow dx="1" dy="3" stdDeviation="1" flood-color="black" flood-opacity="0.3" />
      </filter>
    </defs>
  </svg>
</body>
</html>
